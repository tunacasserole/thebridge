name: Claude Issue Triage

# Automatically analyze and label new issues
on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage Issue with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            Analyze this new GitHub issue and triage it appropriately.

            REPOSITORY: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            AUTHOR: ${{ github.event.issue.user.login }}

            BODY:
            ${{ github.event.issue.body }}

            TRIAGE INSTRUCTIONS:
            1. Determine the issue type:
               - bug: Something isn't working correctly
               - enhancement: New feature or improvement request
               - documentation: Documentation updates needed
               - question: User needs help or clarification

            2. Assess complexity:
               - good first issue: Simple, well-defined, good for newcomers
               - help wanted: Could use community contribution
               - complex: Requires significant effort or expertise

            3. Identify area:
               - frontend: UI/UX related
               - backend: API, database, server-side
               - auth: Authentication/authorization
               - ai: AI/Claude integration
               - infra: DevOps, CI/CD, deployment

            4. Check for:
               - Missing information that should be requested
               - Duplicate issues (search existing issues)
               - Security concerns that need immediate attention

            ACTIONS TO TAKE:
            - Add appropriate labels using: gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2"
            - If information is missing, post a comment asking for clarification
            - If it appears to be a duplicate, comment with a link to the original

            IMPORTANT - UPDATE THE ISSUE BODY:
            After completing your analysis, you MUST append your triage analysis to the original issue body.

            Follow these steps:
            1. Get the current issue body:
               CURRENT_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q .body)

            2. Create your triage analysis in markdown format with:
               - A clear separator (---)
               - "## ðŸ¤– Claude Triage Analysis" heading
               - The labels you added
               - Complexity assessment
               - Area identification
               - Any notes or recommendations

            3. Append your analysis to the issue body:
               echo "$CURRENT_BODY

               ---

               ## ðŸ¤– Claude Triage Analysis

               [Your analysis here in markdown format]
               " | gh issue edit ${{ github.event.issue.number }} --body-file -

            Make sure your analysis is well-formatted and helpful for the user to see directly in the issue.

            NOTE: Do NOT add the 'claude-implement' label. Implementation will be triggered manually.

          # CLI arguments for limits
          claude_args: "--max-turns 10"
